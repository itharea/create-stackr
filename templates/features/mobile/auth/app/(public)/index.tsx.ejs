import React, { useMemo<% if (features.sessionManagement) { %>, useState<% } %> } from 'react';
import {
  View,
  Text,
  StyleSheet,
  SafeAreaView,
  ScrollView,
<% if (features.sessionManagement) { %>  Modal,
  Pressable,
  KeyboardAvoidingView,
  Platform,
<% } %>} from 'react-native';
import { router } from 'expo-router';
<% if (features.sessionManagement) { %>import Constants from 'expo-constants';
<% } %>import { LinearGradient } from 'expo-linear-gradient';
import { Button } from '@/components/ui/button';
<% if (features.sessionManagement) { %>import { Input } from '@/components/ui/input';
<% } %>
import { IconSymbol } from '@/components/ui/icon-symbol';
import { useAppTheme, AppTheme } from '@/context/theme-context';
<% if (features.sessionManagement) { %>import { useSessionActions } from '@/store/device-session-store';
<% } %>

export default function LandingScreen() {
  const theme = useAppTheme();
  const styles = useMemo(() => createStyles(theme), [theme]);
<% if (features.sessionManagement) { %>  const { deleteSession, initializeSession } = useSessionActions();
  const [showDeleteSessionModal, setShowDeleteSessionModal] = useState(false);
  const [deleteSessionConfirmText, setDeleteSessionConfirmText] = useState('');
  const [isDeletingSession, setIsDeletingSession] = useState(false);

  const handleDeleteSession = async () => {
    if (deleteSessionConfirmText !== 'DELETE') {
      return;
    }

    setIsDeletingSession(true);
    try {
      await deleteSession();
      const onboardingEnabled = Constants.expoConfig?.extra?.features?.onboarding?.enabled ?? false;
      setShowDeleteSessionModal(false);
      setDeleteSessionConfirmText('');

      if (onboardingEnabled) {
        router.replace('/(onboarding)/page-1');
      } else {
        await initializeSession();
      }
    } catch (error) {
      console.error('Failed to delete/recreate session:', error);
      setShowDeleteSessionModal(false);
      setDeleteSessionConfirmText('');
    } finally {
      setIsDeletingSession(false);
    }
  };
<% } %>

  // Gradient colors based on theme
  const gradientColors = theme.mode === 'dark'
    ? [theme.colors.card, 'transparent'] as const
    : ['#ffffff', '#f8fafc'] as const;

  const features = [
    'Authentication system',
    'Zustand state management',
    'Error handling',
    'Form validation',
    'API integration',
  ];

  return (
    <SafeAreaView style={styles.container}>
      <ScrollView contentContainerStyle={styles.scrollContent}>
        <View style={styles.content}>
          {/* Hero Section */}
          <View style={styles.heroSection}>
            <Text style={styles.title}>Welcome to Your App!</Text>
            <Text style={styles.subtitle}>
              Get started by creating an account or signing in
            </Text>
          </View>

          {/* Features Section */}
          <LinearGradient
            colors={gradientColors}
            style={styles.section}
            start={{ x: 0, y: 0 }}
            end={{ x: 0, y: 1 }}
          >
            <Text style={styles.sectionTitle}>What's Included</Text>
            <Text style={styles.sectionText}>
              This app comes with everything you need to get started quickly.
            </Text>

            <View style={styles.featureList}>
              {features.map((feature, index) => (
                <View key={index} style={styles.featureRow}>
                  <View style={styles.featureIcon}>
                    <IconSymbol
                      name="checkmark.circle.fill"
                      size={16}
                      color={theme.colors.success}
                    />
                  </View>
                  <Text style={styles.featureText}>{feature}</Text>
                </View>
              ))}
            </View>
          </LinearGradient>

          {/* CTA Section */}
          <View style={styles.actions}>
            <Button
              title="Sign In"
              variant="primary"
              onPress={() => router.push('/(auth)/login')}
              style={styles.signInButton}
            />

            <Button
              title="Create Account"
              variant="outline"
              onPress={() => router.push('/(auth)/register')}
              style={styles.createAccountButton}
            />
<% if (features.sessionManagement) { %>
            <Button
              title="Delete Session"
              variant="outline"
              onPress={() => setShowDeleteSessionModal(true)}
              style={styles.deleteSessionButton}
              textStyle={styles.deleteSessionButtonText}
            />
<% } %>
          </View>
        </View>
      </ScrollView>
<% if (features.sessionManagement) { %>
      {/* Delete Session Confirmation Modal */}
      <Modal
        visible={showDeleteSessionModal}
        transparent
        animationType="fade"
        onRequestClose={() => setShowDeleteSessionModal(false)}
        statusBarTranslucent
      >
        <KeyboardAvoidingView
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={styles.keyboardAvoidingModal}
        >
          <Pressable
            style={styles.modalOverlay}
            onPress={() => setShowDeleteSessionModal(false)}
          >
            <Pressable
              style={styles.modalContent}
              onPress={(e) => e.stopPropagation()}
            >
              <Text style={styles.modalTitle}>Delete Session</Text>

              <View style={styles.warningContainer}>
                <Text style={styles.warningTitle}>Warning</Text>
                <Text style={styles.warningText}>
                  This will delete your anonymous session and all local data. You'll need to go through onboarding again.
                </Text>
              </View>

              <Input
                label="Type DELETE to confirm"
                value={deleteSessionConfirmText}
                onChangeText={setDeleteSessionConfirmText}
                placeholder="DELETE"
                autoCapitalize="characters"
                containerStyle={styles.confirmInput}
              />

              <View style={styles.modalActions}>
                <Button
                  title="Cancel"
                  variant="outline"
                  onPress={() => {
                    setShowDeleteSessionModal(false);
                    setDeleteSessionConfirmText('');
                  }}
                  style={styles.modalButton}
                />

                <Button
                  title={isDeletingSession ? "Deleting..." : "Delete"}
                  variant="primary"
                  onPress={handleDeleteSession}
                  disabled={deleteSessionConfirmText !== 'DELETE'}
                  loading={isDeletingSession}
                  style={StyleSheet.flatten([styles.modalButton, styles.deleteConfirmButton])}
                />
              </View>
            </Pressable>
          </Pressable>
        </KeyboardAvoidingView>
      </Modal>
<% } %>
    </SafeAreaView>
  );
}

const createStyles = (theme: AppTheme) => StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },

  scrollContent: {
    flexGrow: 1,
  },

  content: {
    flex: 1,
    padding: theme.spacing[5],
  },

  heroSection: {
    paddingVertical: theme.spacing[8],
    alignItems: 'center',
  },

  title: {
    fontSize: theme.typography.fontSize['3xl'],
    fontWeight: '800',
    color: theme.colors.text,
    textAlign: 'center',
    marginBottom: theme.spacing[3],
    letterSpacing: -1,
  },

  subtitle: {
    fontSize: theme.typography.fontSize.lg,
    color: theme.colors.textSecondary,
    textAlign: 'center',
    lineHeight: 28,
  },

  section: {
    borderRadius: theme.borderRadius.xl,
    padding: theme.spacing[6],
    marginBottom: theme.spacing[6],
    borderWidth: 1,
    borderColor: theme.colors.borderLight,
  },

  sectionTitle: {
    fontSize: theme.typography.fontSize.lg,
    fontWeight: '700',
    color: theme.colors.text,
    marginBottom: theme.spacing[3],
  },

  sectionText: {
    fontSize: theme.typography.fontSize.base,
    color: theme.colors.textSecondary,
    lineHeight: 24,
    marginBottom: theme.spacing[5],
  },

  featureList: {
    gap: theme.spacing[3],
  },

  featureRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: theme.spacing[3],
  },

  featureIcon: {
    width: 28,
    height: 28,
    borderRadius: theme.borderRadius.full,
    backgroundColor: theme.mode === 'dark' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(16, 185, 129, 0.1)',
    alignItems: 'center',
    justifyContent: 'center',
  },

  featureText: {
    fontSize: theme.typography.fontSize.base,
    color: theme.colors.text,
    fontWeight: '500',
  },

  actions: {
    marginTop: 'auto',
    paddingTop: theme.spacing[5],
  },

  signInButton: {
    marginBottom: theme.spacing[3],
  },

  createAccountButton: {
<% if (features.sessionManagement) { %>    marginBottom: theme.spacing[3],
<% } %>  },
<% if (features.sessionManagement) { %>
  deleteSessionButton: {
    borderColor: theme.colors.error,
  },

  deleteSessionButtonText: {
    color: theme.colors.error,
  },

  // Modal styles
  keyboardAvoidingModal: {
    flex: 1,
  },

  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.7)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: theme.spacing[5],
  },

  modalContent: {
    backgroundColor: theme.colors.background,
    borderRadius: 24,
    padding: theme.spacing[6],
    paddingBottom: theme.spacing[12],
    width: '100%',
    maxWidth: 400,
    borderWidth: 1,
    borderColor: theme.colors.borderLight,
    ...theme.shadows.large,
  },

  modalTitle: {
    fontSize: theme.typography.fontSize['xl'],
    fontWeight: 'bold',
    color: theme.colors.text,
    marginBottom: theme.spacing[6],
    textAlign: 'center',
  },

  warningContainer: {
    backgroundColor: 'transparent',
    borderRadius: theme.borderRadius.lg,
    padding: theme.spacing[4],
    marginBottom: theme.spacing[5],
    borderWidth: 1,
    borderColor: theme.colors.warning,
    borderStyle: 'dashed',
  },

  warningTitle: {
    fontSize: theme.typography.fontSize.base,
    fontWeight: '700',
    color: theme.colors.warning,
    marginBottom: theme.spacing[2],
  },

  warningText: {
    fontSize: theme.typography.fontSize.sm,
    color: theme.colors.textSecondary,
    lineHeight: 20,
  },

  confirmInput: {
    marginBottom: theme.spacing[6],
  },

  modalActions: {
    flexDirection: 'row',
    gap: theme.spacing[3],
  },

  modalButton: {
    flex: 1,
  },

  deleteConfirmButton: {
    backgroundColor: theme.colors.error,
    borderWidth: 0,
  },
<% } %>});
