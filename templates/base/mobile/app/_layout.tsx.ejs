import { Stack, router } from 'expo-router';
import { useEffect<% if (features.sessionManagement) { %>, useState<% } %> } from 'react';
import Constants from 'expo-constants';
<% if (features.onboarding.enabled) { %>import AsyncStorage from '@react-native-async-storage/async-storage';
<% } %><% if (integrations.revenueCat.enabled || integrations.adjust.enabled || integrations.scate.enabled) { %>import { initializeSDKs } from '@/services/sdkInitializer';
<% } %><% if (features.sessionManagement) { %>import { useSessionActions, useSession } from '../src/store/deviceSession.store';
<% } %>import { logger } from '../src/utils/logger';

export default function RootLayout() {
<% if (features.sessionManagement) { %>  const { initializeSession } = useSessionActions();
  const { isSessionChecked } = useSession();
<% } else { %>  const [isReady, setIsReady] = useState(false);
<% } %>
  // Get feature flags from app.json
  const onboardingEnabled = Constants.expoConfig?.extra?.features?.onboarding?.enabled ?? false;

  useEffect(() => {
<% if (integrations.revenueCat.enabled || integrations.adjust.enabled || integrations.scate.enabled) { %>    // Initialize SDKs
    initializeSDKs().catch(console.error);

<% } %>    // App initialization and navigation
    const initializeApp = async () => {
<% if (features.sessionManagement) { %>      // Skip if session already checked
      if (isSessionChecked) {
        logger.debug('RootLayout: Session already checked, skipping');
        return;
      }
<% } %>
      try {
        logger.info('RootLayout: Initializing app...');

<% if (features.onboarding.enabled) { %>        // Check onboarding completion
        const onboardingCompleted = await AsyncStorage.getItem('onboarding_completed');

        if (onboardingEnabled && onboardingCompleted !== 'true') {
          // Onboarding not completed - navigate to onboarding
          logger.info('RootLayout: Onboarding not completed, navigating to onboarding');
          router.replace('/(onboarding)/page-1');
          return;
        }
<% } %>
<% if (features.sessionManagement) { %>        // Initialize session
        logger.info('RootLayout: Initializing session');
        await initializeSession();
<% } %>
        router.replace('/(tabs)');
      } catch (error) {
        logger.error('RootLayout: Failed to initialize app', { error });
        // Fallback to tabs on error
        router.replace('/(tabs)');
      }<% if (!features.sessionManagement) { %> finally {
        setIsReady(true);
      }<% } %>
    };

    initializeApp();
  }, [<% if (features.sessionManagement) { %>isSessionChecked, initializeSession, <% } %>onboardingEnabled]);

  return (
    <Stack screenOptions={{ headerShown: false }}>
<% if (features.onboarding.enabled) { %>      <Stack.Screen name="(onboarding)" />
<% } %><% if (features.authentication.enabled) { %>      <Stack.Screen name="(auth)" />
<% } %><% if (features.paywall) { %>      <Stack.Screen name="paywall" options={{ presentation: 'modal' }} />
<% } %>      <Stack.Screen name="(tabs)" />
      <Stack.Screen name="+not-found" />
    </Stack>
  );
}
