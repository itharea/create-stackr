import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';
import Constants from 'expo-constants';
<% if (features.authentication.enabled) { %>
import { authClient } from '../lib/auth-client';
<% } %>

// Storage key for device sessions (anonymous users)
const DEVICE_SESSION_TOKEN_KEY = 'device_session_token';

// API Configuration
const API_URL = Constants.expoConfig?.extra?.apiUrl || 'http://localhost:8080';

const api = axios.create({
  baseURL: API_URL,
  timeout: 10000, // 10 second timeout
  headers: {
    'Content-Type': 'application/json',
  },
});

// Request interceptor to add auth cookies and device session token
api.interceptors.request.use(
  async (config) => {
    try {
<% if (features.authentication.enabled) { %>
      // Add BetterAuth session cookies for authenticated requests
      const cookies = authClient.getCookie();
      if (cookies) {
        config.headers.Cookie = cookies;
      }
<% } %>

      // Add device session token if available (for anonymous sessions)
      const deviceSessionToken = await AsyncStorage.getItem(DEVICE_SESSION_TOKEN_KEY);
      if (deviceSessionToken) {
        config.headers['X-Device-Session-Token'] = deviceSessionToken;
      }

      return config;
    } catch (error) {
      console.error('API Request Error:', error);
      return config;
    }
  },
  (error) => {
    console.error('API Request Setup Error:', error);
    return Promise.reject(error);
  }
);

// Response interceptor for handling common responses and errors
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    // Handle 401 errors - session expired or invalid
    if (error.response?.status === 401) {
<% if (features.authentication.enabled) { %>
      // Sign out to clear BetterAuth session
      try {
        await authClient.signOut();
      } catch {
        // Ignore sign out errors
      }
<% } %>
    }
    return Promise.reject(error);
  }
);

export default api;
